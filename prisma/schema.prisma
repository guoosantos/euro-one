generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id          String   @id @default(uuid())
  name        String
  deviceLimit Int      @default(0)
  userLimit   Int      @default(0)
  attributes  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users    User[]
  devices  Device[]
  vehicles Vehicle[]
  chips    Chip[]
  groups   Group[]
  models   Model[]
  prefs    UserPreference[]
}

model User {
  id                 String   @id @default(uuid())
  name               String
  email              String   @unique
  emailNormalized    String?  @unique
  username           String?
  usernameNormalized String?  @unique
  passwordHash       String
  role               String
  clientId           String?
  attributes         Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client      Client?          @relation(fields: [clientId], references: [id])
  preferences UserPreference[]
}

model Model {
  id           String   @id @default(uuid())
  clientId     String
  name         String
  brand        String?
  chipset      String?
  protocol     String?
  connectivity String?
  ports        Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
}

model Device {
  id         String   @id @default(uuid())
  clientId   String
  name       String?
  uniqueId   String   @unique
  modelId    String?
  traccarId  String?  @unique
  chipId     String?  @unique
  vehicleId  String?  @unique
  attributes Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  model   Model?   @relation(fields: [modelId], references: [id])
  chip    Chip?    @relation(fields: [chipId], references: [id], onDelete: SetNull)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
}

model Chip {
  id        String   @id @default(uuid())
  clientId  String
  iccid     String   @unique
  phone     String?
  carrier   String?
  status    String?
  apn       String?
  apnUser   String?
  apnPass   String?
  notes     String?
  provider  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
}

model Vehicle {
  id        String   @id @default(uuid())
  clientId  String
  name      String?
  plate     String
  driver    String?
  group     String?
  type      String?
  status    String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
}

model Group {
  id        String   @id @default(uuid())
  clientId  String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id])
}

model UserPreference {
  id        String   @id @default(uuid())
  userId    String   @unique
  clientId  String
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  client Client @relation(fields: [clientId], references: [id])
}

model GeocodeCache {
  key       String   @id
  data      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CrmClient {
  id                      String    @id @default(uuid())
  clientId                String
  cnpj                    String?
  name                    String
  segment                 String?
  companySize             String?
  city                    String?
  state                   String?
  website                 String?
  mainContactName         String?
  mainContactRole         String?
  mainContactPhone        String?
  mainContactEmail        String?
  interestLevel           String?
  closeProbability        String?
  tags                    Json?
  hasCompetitorContract   Boolean   @default(false)
  competitorName          String?
  competitorContractStart DateTime?
  competitorContractEnd   DateTime?
  inTrial                 Boolean   @default(false)
  trialProduct            String?
  trialStart              DateTime?
  trialDurationDays       Int?
  trialEnd                DateTime?
  notes                   String?
  relationshipType        String?
  createdByUserId         String?
  reservedDeviceIds       Json?
  contractStart           DateTime?
  contractDurationDays    Int?
  contractEnd             DateTime?
  convertedClientId       String?
  traccarGroupId          String?
  traccarGroupName        String?
  traccarUserId           String?
  conversionError         String?
  dealId                  String?
  contacts                Json?
  soldDeviceIds           Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model CrmTag {
  id        String   @id @default(uuid())
  clientId  String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PipelineStage {
  id          String   @id @default(uuid())
  clientId    String?
  name        String
  order       Int
  probability Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deals Deal[]
}

model Deal {
  id                String    @id @default(uuid())
  clientId          String?
  crmClientId       String?
  title             String
  value             Float     @default(0)
  probability       Int?
  stageId           String
  status            String    @default("open")
  ownerUserId       String?
  expectedCloseDate DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  wonAt             DateTime?
  lostAt            DateTime?
  soldDeviceIds     Json?

  stage PipelineStage @relation(fields: [stageId], references: [id])
}

model Activity {
  id              String    @id @default(uuid())
  clientId        String?
  crmClientId     String?
  dealId          String?
  type            String
  date            DateTime?
  result          String?
  notes           String?
  createdByUserId String?
  createdAt       DateTime  @default(now())
}

model Reminder {
  id              String    @id @default(uuid())
  clientId        String?
  crmClientId     String?
  dealId          String?
  description     String
  remindAt        DateTime?
  category        String?
  status          String    @default("pending")
  createdByUserId String?
  createdAt       DateTime  @default(now())
}

model Task {
  id                 String    @id @default(uuid())
  clientId           String
  vehicleId          String?
  driverId           String?
  address            String?
  geoFenceId         String?
  geofenceRadius     Int?
  latitude           Float?
  longitude          Float?
  startTimeExpected  DateTime?
  endTimeExpected    DateTime?
  arrivalTime        DateTime?
  serviceStartTime   DateTime?
  serviceEndTime     DateTime?
  checklistCompleted Boolean   @default(false)
  type               String
  status             String
  attachments        Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model TaskTemplate {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  description String?
  payload     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model GeofenceGroup {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client    Client                    @relation(fields: [clientId], references: [id])
  geofences GeofenceGroupAssignment[]
}

model GeofenceGroupAssignment {
  id              String   @id @default(uuid())
  clientId        String
  geofenceGroupId String
  geofenceId      String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client        Client        @relation(fields: [clientId], references: [id])
  geofenceGroup GeofenceGroup @relation(fields: [geofenceGroupId], references: [id])

  @@unique([geofenceGroupId, geofenceId])
}
