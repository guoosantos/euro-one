generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id          String   @id @default(uuid())
  name        String
  deviceLimit Int      @default(0)
  userLimit   Int      @default(0)
  attributes  Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users             User[]
  devices           Device[]
  vehicles          Vehicle[]
  chips             Chip[]
  groups            Group[]
  models            Model[]
  prefs             UserPreference[]
  telemetryMappings TelemetryFieldMapping[]
  eventMappings     EventMapping[]

  routes         Route[]
  geofences      Geofence[]
  geofenceGroups GeofenceGroup[]

  commandDispatches CommandDispatch[]
  customCommands    CustomCommand[]
  equipmentProducts EquipmentProduct[]
  equipments        Equipment[]
  serviceOrders     ServiceOrder[]
  euroImportLogs    EuroImportLog[]
}

model User {
  id                 String   @id @default(uuid())
  name               String
  email              String   @unique
  emailNormalized    String?  @unique
  username           String?
  usernameNormalized String?  @unique
  passwordHash       String
  role               String
  clientId           String?
  attributes         Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  client           Client?          @relation(fields: [clientId], references: [id])
  preferences      UserPreference[]
  geofencesCreated Geofence[]
  euroImportLogs  EuroImportLog[]
}

model Model {
  id           String   @id @default(uuid())
  clientId     String
  name         String
  brand        String?
  chipset      String?
  protocol     String?
  connectivity String?
  ports        Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
}

model Device {
  id         String   @id @default(uuid())
  clientId   String
  name       String?
  uniqueId   String   @unique
  modelId    String?
  traccarId  String?  @unique
  chipId     String?  @unique
  vehicleId  String?  @unique
  attributes Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  model   Model?   @relation(fields: [modelId], references: [id])
  chip    Chip?    @relation(fields: [chipId], references: [id], onDelete: SetNull)
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id], onDelete: SetNull)

  telemetryMappings TelemetryFieldMapping[]
  eventMappings     EventMapping[]
}

model Chip {
  id        String   @id @default(uuid())
  clientId  String
  iccid     String   @unique
  phone     String?
  carrier   String?
  status    String?
  apn       String?
  apnUser   String?
  apnPass   String?
  notes     String?
  provider  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
}

model Vehicle {
  id        String   @id @default(uuid())
  clientId  String
  name      String?
  item      String?
  plate     String
  identifier String?
  model     String?
  brand     String?
  chassis   String?
  renavam   String?
  color     String?
  externalRef String?
  modelYear Int?
  manufactureYear Int?
  fipeCode  String?
  fipeValue Float?
  zeroKm    Boolean  @default(false)
  driver    String?
  group     String?
  type      String?
  status    String?
  notes     String?
  attributes Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  devices Device[]
  equipments Equipment[]
  serviceOrders ServiceOrder[]
}

model EquipmentProduct {
  id             String   @id @default(uuid())
  clientId       String
  name           String
  nameNormalized String
  isNonTracked   Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client    Client     @relation(fields: [clientId], references: [id])
  equipments Equipment[]

  @@unique([clientId, nameNormalized])
  @@index([clientId])
}

model Equipment {
  id             String   @id @default(uuid())
  clientId       String
  vehicleId      String?
  productId      String?
  internalId     String
  status         String?
  condition      String?
  location       String?
  warrantyDays   Int?
  priceValue     Float?
  externalRef    String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  client  Client           @relation(fields: [clientId], references: [id])
  vehicle Vehicle?         @relation(fields: [vehicleId], references: [id])
  product EquipmentProduct? @relation(fields: [productId], references: [id])

  @@unique([clientId, internalId])
  @@index([clientId, vehicleId])
}

model ServiceOrder {
  id               String   @id @default(uuid())
  clientId         String
  clientName       String?
  vehicleId        String?
  osInternalId     String
  type             String?
  status           String?
  startAt          DateTime?
  endAt            DateTime?
  technicianName   String?
  address          String?
  addressStart     String?
  addressReturn    String?
  km               Float?
  reason           String?
  notes            String?
  responsibleName  String?
  responsiblePhone String?
  clientValue      Float?
  technicianValue  Float?
  serial           String?
  externalRef      String?
  equipmentsText   String?
  equipmentsData   Json?
  checklistItems   Json?
  signatures       Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client  Client   @relation(fields: [clientId], references: [id])
  vehicle Vehicle? @relation(fields: [vehicleId], references: [id])

  @@unique([clientId, osInternalId])
  @@index([clientId, vehicleId])
}

model EuroImportLog {
  id         String   @id @default(uuid())
  clientId   String?
  userId     String?
  fileName   String
  mode       String
  importMode String
  summary    Json?
  warnings   Json?
  errors     Json?
  createdAt  DateTime @default(now())

  client Client? @relation(fields: [clientId], references: [id])
  user   User?   @relation(fields: [userId], references: [id])

  @@index([clientId, createdAt])
  @@index([userId, createdAt])
}

model Group {
  id        String   @id @default(uuid())
  clientId  String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id])
}

model UserPreference {
  id        String   @id @default(uuid())
  userId    String   @unique
  clientId  String
  payload   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id])
  client Client @relation(fields: [clientId], references: [id])
}

model GeocodeCache {
  key         String   @id
  data        Json
  latCenter   Float?
  lonCenter   Float?
  addressText String?
  addressJson Json?
  provider    String?
  hitsCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Geofence {
  id              String   @id @default(uuid())
  clientId        String
  groupId         String?
  name            String
  description     String?
  type            String
  color           String?
  isTarget        Boolean  @default(false)
  geometryJson    Json?
  kml             String?
  createdByUserId String?
  points          Json?
  centerLat       Float?
  centerLng       Float?
  radius          Float?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client    Client         @relation(fields: [clientId], references: [id])
  group     GeofenceGroup? @relation(fields: [groupId], references: [id])
  createdBy User?          @relation(fields: [createdByUserId], references: [id])

  @@map("geofence")
}

model CrmClient {
  id                      String    @id @default(uuid())
  clientId                String
  cnpj                    String?
  name                    String
  segment                 String?
  companySize             String?
  city                    String?
  state                   String?
  website                 String?
  mainContactName         String?
  mainContactRole         String?
  mainContactPhone        String?
  mainContactEmail        String?
  interestLevel           String?
  closeProbability        String?
  tags                    Json?
  hasCompetitorContract   Boolean   @default(false)
  competitorName          String?
  competitorContractStart DateTime?
  competitorContractEnd   DateTime?
  inTrial                 Boolean   @default(false)
  trialProduct            String?
  trialStart              DateTime?
  trialDurationDays       Int?
  trialEnd                DateTime?
  notes                   String?
  relationshipType        String?
  createdByUserId         String?
  reservedDeviceIds       Json?
  contractStart           DateTime?
  contractDurationDays    Int?
  contractEnd             DateTime?
  convertedClientId       String?
  traccarGroupId          String?
  traccarGroupName        String?
  traccarUserId           String?
  conversionError         String?
  dealId                  String?
  contacts                Json?
  soldDeviceIds           Json?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
}

model CrmTag {
  id        String   @id @default(uuid())
  clientId  String
  name      String
  color     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PipelineStage {
  id          String   @id @default(uuid())
  clientId    String?
  name        String
  order       Int
  probability Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deals Deal[]
}

model Deal {
  id                String    @id @default(uuid())
  clientId          String?
  crmClientId       String?
  title             String
  value             Float     @default(0)
  probability       Int?
  stageId           String
  status            String    @default("open")
  ownerUserId       String?
  expectedCloseDate DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  wonAt             DateTime?
  lostAt            DateTime?
  soldDeviceIds     Json?

  stage PipelineStage @relation(fields: [stageId], references: [id])
}

model Activity {
  id              String    @id @default(uuid())
  clientId        String?
  crmClientId     String?
  dealId          String?
  type            String
  date            DateTime?
  result          String?
  notes           String?
  createdByUserId String?
  createdAt       DateTime  @default(now())
}

model Reminder {
  id              String    @id @default(uuid())
  clientId        String?
  crmClientId     String?
  dealId          String?
  description     String
  remindAt        DateTime?
  category        String?
  status          String    @default("pending")
  createdByUserId String?
  createdAt       DateTime  @default(now())
}

model Task {
  id                 String    @id @default(uuid())
  clientId           String
  vehicleId          String?
  driverId           String?
  address            String?
  geoFenceId         String?
  geofenceRadius     Int?
  latitude           Float?
  longitude          Float?
  startTimeExpected  DateTime?
  endTimeExpected    DateTime?
  arrivalTime        DateTime?
  serviceStartTime   DateTime?
  serviceEndTime     DateTime?
  checklistCompleted Boolean   @default(false)
  type               String
  status             String
  attachments        Json?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
}

model TaskTemplate {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  description String?
  payload     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Route {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  description String?
  color       String?
  mode        String   @default("car")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client       @relation(fields: [clientId], references: [id])
  points RoutePoint[]

  @@index([clientId], map: "route_clientId_idx")
  @@map("route")
}

model RoutePoint {
  id        String   @id @default(uuid())
  routeId   String
  latitude  Float
  longitude Float
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  route Route @relation(fields: [routeId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@unique([routeId, order], map: "route_point_routeId_order_key")
  @@index([routeId], map: "route_point_routeId_idx")
  @@map("route_point")
}

model GeofenceGroup {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  color       String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client    Client     @relation(fields: [clientId], references: [id])
  geofences Geofence[]

  @@map("geofence_group")
}

model TelemetryFieldMapping {
  id        String   @id @default(uuid())
  clientId  String
  deviceId  String?
  protocol  String?
  key       String
  label     String
  dataType  String   @default("string")
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client  @relation(fields: [clientId], references: [id])
  device Device? @relation(fields: [deviceId], references: [id])

  @@unique([clientId, deviceId, protocol, key])
}

model EventMapping {
  id        String   @id @default(uuid())
  clientId  String
  deviceId  String?
  protocol  String?
  eventKey  String
  label     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client  @relation(fields: [clientId], references: [id])
  device Device? @relation(fields: [deviceId], references: [id])

  @@unique([clientId, deviceId, protocol, eventKey])
}

model CommandDispatch {
  id             String   @id @default(uuid())
  clientId       String?
  vehicleId      String
  traccarId      Int
  commandKey     String?
  commandName    String?
  traccarCommandId Int?
  payloadSummary Json?
  sentAt         DateTime
  status         String
  createdBy      String?
  createdAt      DateTime @default(now())

  client Client? @relation(fields: [clientId], references: [id])

  @@index([vehicleId, sentAt])
  @@index([clientId, vehicleId, sentAt])
  @@map("command_dispatches")
}

model CustomCommand {
  id          String   @id @default(uuid())
  clientId    String
  name        String
  description String?
  protocol    String?
  kind        String
  payload     Json
  visible     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id])

  @@index([clientId, visible])
  @@index([clientId, protocol])
  @@index([clientId, sortOrder])
  @@map("custom_commands")
}
